name: Schema Filter by Project v1
inputs:
  - {name: bearer_token, type: string, description: "Path to file containing bearer token"}
  - {name: domain, type: String, description: "Base domain, e.g. https://igs.gov-cloud.ai"}
  - {name: schema_id, type: String, description: "Schema ID for the entity instances"}
  - {name: project_id, type: String, description: "Project ID to filter schemas"}
  - {name: attributes_to_be_pick, type: String, description: "Comma-separated list of attributes to include (optional, if empty picks all)", default: ""}

outputs:
  - {name: schema_output, type: String, description: "JSON file with filtered schemas"}

implementation:
  container:
    image: gurpreetgandhi/nesy-factory:vtest4
    command:
      - python3
      - -u
      - -c
      - |
        import argparse
        import json
        import os
        import sys
        import requests

        parser = argparse.ArgumentParser(description="Filter schemas by project ID")
        parser.add_argument('--bearer_token', required=True)
        parser.add_argument('--domain', required=True)
        parser.add_argument('--schema_id', required=True)
        parser.add_argument('--project_id', required=True)
        parser.add_argument('--attributes_to_be_pick', default="")
        parser.add_argument('--schema_output', required=True)
        args = parser.parse_args()

        # Read bearer token
        try:
            with open(args.bearer_token, "r", encoding="utf-8") as f:
                token = f.read().strip()
        except Exception as e:
            print(f"[ERROR] Failed to read bearer token: {e}", file=sys.stderr)
            sys.exit(1)

        # Parse attributes to pick
        attributes_list = []
        if args.attributes_to_be_pick and args.attributes_to_be_pick.strip():
            attributes_list = [attr.strip() for attr in args.attributes_to_be_pick.split(",") if attr.strip()]
            print(f"[INFO] Filtering attributes: {attributes_list}")
        else:
            print("[INFO] No attribute filter specified - including all attributes")

        # Build filter with project_id
        filter_obj = {"projectId": args.project_id}
        
        print(f"[INFO] Filtering by projectId: {args.project_id}")

        # Construct URL
        url = (
            f"{args.domain.rstrip('/')}"
            f"/pi-entity-instances-service/v3.0/schemas/{args.schema_id}/instances/list"
        )

        # Build request payload
        payload = {
            "dbType": "TIDB",
            "ownedOnly": True,
            "filter": filter_obj
        }

        # Headers
        headers = {
            "Authorization": f"Bearer {token}",
            "Content-Type": "application/json"
        }

        # Print debug information
        print(f"[DEBUG] API URL: {url}")
        print(f"[DEBUG] Filter: {json.dumps(filter_obj, indent=2)}")
        print(f"[DEBUG] Full Payload: {json.dumps(payload, indent=2)}")

        # Make the request
        try:
            print("[INFO] Making API request...")
            response = requests.post(url, headers=headers, json=payload, timeout=60)
            
            if not response.ok:
                error_detail = ""
                try:
                    error_json = response.json()
                    error_detail = json.dumps(error_json, indent=2)
                except:
                    error_detail = response.text
                
                print(f"[ERROR] API request failed with status {response.status_code}", file=sys.stderr)
                print(f"[ERROR] Response: {error_detail}", file=sys.stderr)
                response.raise_for_status()

            # Parse response
            data = response.json()
            print(f"[DEBUG] API Response: {json.dumps(data, indent=2)}")

            # Extract instances list from 'content' key
            instances = data.get("content", [])
            
            # Validate that filtered results are not empty
            if not instances or len(instances) == 0:
                print(f"[ERROR] No schemas found for project_id: {args.project_id}", file=sys.stderr)
                print("[ERROR] Filtered result is empty - execution cannot proceed", file=sys.stderr)
                sys.exit(1)

            print(f"[INFO] Found {len(instances)} schema(s) for project_id: {args.project_id}")

            # Filter attributes if specified
            filtered_instances = []
            if attributes_list:
                for instance in instances:
                    filtered_instance = {}
                    for attr in attributes_list:
                        if attr in instance:
                            filtered_instance[attr] = instance[attr]
                        else:
                            print(f"[WARNING] Attribute '{attr}' not found in instance", file=sys.stderr)
                    filtered_instances.append(filtered_instance)
                print(f"[INFO] Filtered instances to include only: {attributes_list}")
            else:
                # No filtering - keep all attributes
                filtered_instances = instances

            # Prepare output JSON with filtered schemas
            output_data = {
                "project_id": args.project_id,
                "schema_id": args.schema_id,
                "total_count": len(filtered_instances),
                "attributes_included": attributes_list if attributes_list else "all",
                "schemas": filtered_instances
            }

            # Write output JSON file
            os.makedirs(os.path.dirname(args.schema_output), exist_ok=True)
            
            with open(args.schema_output, "w", encoding="utf-8") as f:
                json.dump(output_data, f, indent=2, ensure_ascii=False)

            # Print success
            print("[SUCCESS] Schemas filtered successfully:")
            print(f"  - Project ID: {args.project_id}")
            print(f"  - Total schemas found: {len(filtered_instances)}")
            if attributes_list:
                print(f"  - Attributes included: {', '.join(attributes_list)}")
            else:
                print(f"  - Attributes included: all")
            print(f"  - Output written to: {args.schema_output}")

        except requests.exceptions.RequestException as e:
            print(f"[ERROR] Request failed: {str(e)}", file=sys.stderr)
            sys.exit(1)
        except Exception as e:
            print(f"[ERROR] Unexpected error: {str(e)}", file=sys.stderr)
            import traceback
            traceback.print_exc()
            sys.exit(1)

    args:
      - --bearer_token
      - {inputPath: bearer_token}
      - --domain
      - {inputValue: domain}
      - --schema_id
      - {inputValue: schema_id}
      - --project_id
      - {inputValue: project_id}
      - --attributes_to_be_pick
      - {inputValue: attributes_to_be_pick}
      - --schema_output
      - {outputPath: schema_output}
