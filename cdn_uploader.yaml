name: ANOVA Results CDN Uploader v1.1
inputs:
  - {name: anova_results, type: String, description: "Path to ANOVA results JSON file to upload"}
  - {name: bearer_token, type: string, description: "Path to a file containing bearer token"}
  - {name: domain, type: String, description: "Domain root for upload endpoint, e.g. https://api.example.com"}
  - {name: get_cdn, type: String, description: "CDN base URL to prefix returned relative cdnUrl"}
outputs:
  - {name: anova_results_cdn, type: String, description: "JSON containing the ANOVA results CDN URL (and optional name)"}

implementation:
  container:
    image: gurpreetgandhi/nesy-factory:vtest4
    command:
      - python3
      - -u
      - -c
      - |
        import argparse
        import subprocess
        import json
        import os
        import uuid
        import tempfile
        import shutil
        import sys
        import traceback

        parser = argparse.ArgumentParser(description="Upload ANOVA results to CDN.")
        parser.add_argument('--anova_results', type=str, required=True)
        parser.add_argument('--anova_results_cdn', type=str, required=True)
        parser.add_argument('--bearer_token', type=str, required=True)
        parser.add_argument('--domain', type=str, required=True)
        parser.add_argument('--get_cdn', type=str, required=True)
        args = parser.parse_args()

        def ensure_parent_dir(path):
            parent = os.path.dirname(path)
            if parent:
                os.makedirs(parent, exist_ok=True)

        def atomic_write_json(path, data):
            ensure_parent_dir(path)
            dirp = os.path.dirname(path) or "/tmp"
            fd, tmp = tempfile.mkstemp(prefix="tmp_json_", dir=dirp)
            try:
                with os.fdopen(fd, "w", encoding="utf-8") as f:
                    json.dump(data, f, ensure_ascii=False, indent=2)
                os.replace(tmp, path)
            except Exception:
                try:
                    os.remove(tmp)
                except Exception:
                    pass
                raise

        def encode_special_chars(text):
            text = text.replace("$", "%24")
            text = text.replace("(", "%28")
            text = text.replace(")", "%29")
            text = text.replace("[", "%5B")
            text = text.replace("]", "%5D")
            text = text.replace("{", "%7B")
            text = text.replace("}", "%7D")
            text = text.replace(" ", "%20")
            return text

        # Read bearer token from provided path
        print(f"[INFO] Reading bearer token from: {args.bearer_token}")
        try:
            with open(args.bearer_token, 'r', encoding='utf-8') as f:
                bearer_token = f.read().strip()
            print("[INFO] Bearer token loaded successfully")
        except Exception as e:
            print(f"[ERROR] Failed to read bearer token: {e}", file=sys.stderr)
            sys.exit(1)

        # Verify ANOVA results file exists
        if not os.path.exists(args.anova_results):
            print(f"[ERROR] ANOVA results file not found: {args.anova_results}", file=sys.stderr)
            sys.exit(1)

        print(f"[INFO] ANOVA results file found: {args.anova_results}")

        # Upload endpoint
        upload_url = f"{args.domain.rstrip('/')}/mobius-content-service/v1.0/content/upload?filePathAccess=private&filePath=%2Fbottle%2Flimka%2Fsoda%2F"
        print(f"[DEBUG] Upload URL: {upload_url}")

        def build_output_dict(key, url):
            out = {key: url}
            return out

        def run_curl_upload(file_path):
            print(f"[INFO] Uploading file: {file_path}")
            
            curl_command = [
                "curl",
                "--location", upload_url,
                "--header", f"Authorization: Bearer {bearer_token}",
                "--form", f"file=@{file_path}",
                "--fail",
                "--show-error"
            ]
            
            proc = subprocess.run(curl_command, capture_output=True)
            stdout = proc.stdout.decode("utf-8", errors="ignore")
            stderr = proc.stderr.decode("utf-8", errors="ignore")
            
            if proc.returncode != 0:
                print(f"[ERROR] curl failed. Return code: {proc.returncode}", file=sys.stderr)
                print(f"[ERROR] curl stdout: {stdout}", file=sys.stderr)
                print(f"[ERROR] curl stderr: {stderr}", file=sys.stderr)
                raise subprocess.CalledProcessError(
                    proc.returncode, 
                    curl_command, 
                    output=stdout.encode(), 
                    stderr=stderr.encode()
                )
            
            try:
                resp = json.loads(stdout)
                print("[INFO] Upload response received successfully")
                return resp
            except Exception as e:
                print(f"[ERROR] Failed to parse upload response as JSON: {e}", file=sys.stderr)
                print(f"[ERROR] Raw response: {stdout}", file=sys.stderr)
                raise

        def prepare_file_for_upload(input_path):
            if not os.path.exists(input_path):
                raise FileNotFoundError(f"Path not found: {input_path}")
            
            if not os.path.isfile(input_path):
                raise ValueError(f"Path is not a file: {input_path}")
            
            # Sanitize filename before uploading
            original_name = os.path.basename(input_path)
            sanitized_name = encode_special_chars(original_name)
            
            if sanitized_name != original_name:
                # Create a copy with sanitized name
                temp_dir = "/tmp"
                sanitized_path = os.path.join(temp_dir, sanitized_name)
                shutil.copy2(input_path, sanitized_path)
                print(f"[INFO] Created sanitized copy: {sanitized_name}")
                return sanitized_path, sanitized_path  # Return path and temp file to clean
            
            return input_path, None  # No temp file created

        def upload_file_to_cdn(file_path, output_json_path, output_key):
            print(f"[DEBUG] Uploading {file_path} -> output {output_json_path} key '{output_key}'")
            
            resp = run_curl_upload(file_path)
            
            relative_cdn_url = resp.get("cdnUrl")
            if not relative_cdn_url:
                raise ValueError("Missing 'cdnUrl' in CDN response")
            encoded_cdn_url = encode_special_chars(relative_cdn_url)
            print(f"[INFO] Original cdnUrl:  {relative_cdn_url}")
            print(f"[INFO] Encoded cdnUrl:   {encoded_cdn_url}")
            
            final_url = f"{args.get_cdn.rstrip('/')}{encoded_cdn_url}"
            
            out_obj = build_output_dict(output_key, final_url)
            
            atomic_write_json(output_json_path, out_obj)
            
            print(f"[INFO] Wrote {output_key} -> {output_json_path}")
            print(f"[CDN] {output_key}: {final_url}")
            
            return final_url

        # Main execution
        try:
            print("[INFO] Starting ANOVA results upload process...")
            
            # Prepare ANOVA results file for upload
            prepared_file, temp_file = prepare_file_for_upload(args.anova_results)
            
            try:
                # Upload to CDN
                anova_cdn_url = upload_file_to_cdn(
                    prepared_file, 
                    args.anova_results_cdn, 
                    "anova_results_cdn"
                )
                
                print("[SUCCESS] ANOVA results uploaded successfully!")
                print(f"  - Input file: {args.anova_results}")
                print(f"  - CDN URL: {anova_cdn_url}")
                print(f"  - Output JSON: {args.anova_results_cdn}")
                
            finally:
                # Clean up temporary file if created
                if temp_file and os.path.exists(temp_file):
                    try:
                        os.remove(temp_file)
                        print(f"[INFO] Cleaned up temporary file: {temp_file}")
                    except Exception as cleanup_error:
                        print(f"[WARNING] Failed to cleanup temp file: {cleanup_error}", file=sys.stderr)

        except Exception as e:
            print(f"[ERROR] ANOVA results upload failed: {str(e)}", file=sys.stderr)
            traceback.print_exc()
            sys.exit(1)

    args:
      - --anova_results
      - {inputPath: anova_results}
      - --bearer_token
      - {inputPath: bearer_token}
      - --domain
      - {inputValue: domain}
      - --get_cdn
      - {inputValue: get_cdn}
      - --anova_results_cdn
      - {outputPath: anova_results_cdn}
